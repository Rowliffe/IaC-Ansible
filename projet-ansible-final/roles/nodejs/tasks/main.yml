---
- name: Install Node.js
  ansible.builtin.apt:
    name:
      - nodejs
      - npm
    state: present

- name: Create app directory
  ansible.builtin.file:
    path: /opt/myapp
    state: directory
    mode: '0755'

- name: Copy package.json
  ansible.builtin.copy:
    src: package.json
    dest: /opt/myapp/package.json
    mode: '0644'

- name: Copy app.js
  ansible.builtin.copy:
    src: app.js
    dest: /opt/myapp/app.js
    mode: '0644'
  notify: Restart Node App

- name: Install npm dependencies
  community.general.npm:
    path: /opt/myapp
    production: true
    state: present

- name: Check if Node App is already running
  ansible.builtin.command: pgrep -f "node app[.]js"
  register: nodejs_running
  failed_when: false
  changed_when: false

- name: Start Node App (background)
  ansible.builtin.shell: |
    nohup node app.js > app.log 2>&1 &
  args:
    chdir: /opt/myapp
  environment:
    DB_USER: "{{ db_user }}"
    DB_PASSWORD: "{{ db_password }}"
    DB_NAME: "{{ db_name }}"
    DB_HOST: "localhost"
    APP_PORT: "{{ app_port }}"
  async: 45
  poll: 0
  when: nodejs_running.rc != 0
  changed_when: true
